#!/usr/bin/env node
'use strict';
const copy = require('../lib/tasks/copy-dir');
const clone = require('../lib/tasks/get-repo');
const install = require('../lib/tasks/npm-install');
const runTaskfile = require('../lib/tasks/run-taskfile');
const renderApiDocs = require('./generate-api');

module.exports = async function gatherDocumentation(options) {
    console.log('cloning repository...');
    await clone(options.clone);

    console.log('npm install');

    await install(options.install);

    console.log('run taskfile');

    await runTaskfile(options.taskfile);

    console.log('copy documentation over...');
    await copy(options.copy);

    console.log('rendering api documentation');
    await renderApiDocs(options.renderDocs).catch(console.error)
};

(async () => {

    const target = '/tmp/core.io';

    module.exports({
        clone: {
            repository: 'goliatone/application-core#build_docs', 
            target
        },
        install: {
            dryRun: false,
            target: `${target}/application-core`
        },

        taskfile: {
            cwd: `${target}/application-core`,
            shell: false,
            stdio: 'inherit',
            argv: ['docs:html']
        },
        copy: {
            source: `${target}/application-core/docs/api`,
            target: `${target}/output/documentation/api`
        },
        renderDocs: {
            cwd: `${target}/output`,
            source: `${target}/output/documentation/api/index.html`,
            template: './templates/api/index.swig'
        },
    });
})();